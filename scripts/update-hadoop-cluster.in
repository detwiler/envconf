#! /bin/env bash

package="$1"

redowl_libdir='/usr/lib/hadoop/lib/redowl'

# stop jobtracker on master node
echo "Stopping jobtracker on master node"
until sudo systemctl stop hadoop@HADOOP_DAEMON_VERSION@-jobtracker.service; do sleep 1; done

# install new package on master node
echo
echo "Installing $package on master node"
sudo rm -rf $redowl_libdir
sudo mkdir $redowl_libdir
sudo tar -xzf $package -C $redowl_libdir

# stop tasktrackers, install package, restart tasktrackers on slave nodes
for slave in $(seq --equal-width 05 09); do
  echo
  echo "Updating redowl-slave-$slave"
  rsync $package redowl-slave-$slave:~/
  echo
  echo "Installing $package"
  ssh -t redowl-slave-$slave "sudo rm -rf $redowl_libdir"
  ssh -t redowl-slave-$slave "sudo mkdir $redowl_libdir"
  ssh -t redowl-slave-$slave "sudo tar -xzf $package -C $redowl_libdir"
  echo
  echo "Restarting tasktracker"
  ssh -t redowl-slave-$slave 'until sudo systemctl restart hadoop@HADOOP_DAEMON_VERSION@-tasktracker.service; do sleep 1; done '
done

# start jobtracker on master node
echo
echo "Starting jobtracker on master node"
until sudo systemctl start hadoop@HADOOP_DAEMON_VERSION@-jobtracker.service; do sleep 1; done

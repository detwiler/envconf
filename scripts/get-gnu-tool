#! /bin/bash

# functions

function usage()
{
	cat <<- eof

	Usage: $(basename $0) -v <version> [OPTIONS] <tool>

	  -v version
	  -p prefix
	  -e exec-prefix
	  -f extra configure flags

	Examples:

	$(basename $0) -v 2.68 -p $HOME/usr -e $HOME/usr/$(arch) autoconf

	eof
} # usage()

prefix_arg=""
exec_prefix_arg=""
flags=""

while getopts ":v:p:e:" opt; do
  case $opt in
    v ) version=$OPTARG ;;
    p ) prefix_arg="--prefix=$OPTARG" ;;
    e ) exec_prefix_arg="--exec-prefix=$OPTARG" ;;
    f ) flags="$flags $OPTARG" ;;
    \? ) usage; exit 1 ;;
  esac
done

shift $(($OPTIND - 1))

if [[ -z $version ]]; then
  echo "Must specify version with -v"
  usage
  exit 1
fi

tool=$1

if [[ -z $tool ]]; then
  echo "Must specify tool argument"
  usage
  exit 1
fi

baseurl="http://ftp.gnu.org/gnu"

tmpdir=$(mktemp -d)

if ! pushd $tmpdir; then
  echo "Failed to create temporary directory"
  exit 1
fi

toolname="$tool-$version"
archive="$toolname.tar.gz"
url="$baseurl/$tool/$archive"

if ! wget $url; then
  echo "Failed to donwload $url"
  exit 1
fi

if ! tar -xzf $archive; then
  echo "Failed to extract $archive"
  exit 1
fi

if ! pushd $toolname; then
  echo "Failed to change directory to $toolname"
  exit 1
fi

echo "Running ./configure $prefix_arg $exec_prefix_arg"

if ! ./configure $prefix_arg $exec_prefix_arg; then
  echo "Failed to configure $toolname"
  exit 1
fi

if ! make; then
  echo "Failed to make $toolname"
  exit 1
fi

if ! make install; then
  echo "Failed to install $toolname"
  exit 1
fi

popd

if ! rm -rf $toolname $archive; then
  echo "Failed to clean $toolname"
  exit 1
fi

echo "Successfully installed $toolname"

popd

rm -rf $tmpdir
